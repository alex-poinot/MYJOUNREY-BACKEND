# Configuration Nginx de debug pour diagnostiquer le problème
# À utiliser temporairement pour identifier le problème

server {
    listen 443 ssl http2;
    server_name myjourney-test.grant-thornton.fr;

    # Configuration SSL (à adapter selon votre certificat)
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;

    # Logs détaillés pour debug
    access_log /var/log/nginx/myjourney-debug.access.log;
    error_log /var/log/nginx/myjourney-debug.error.log debug;

    # Test de connectivité vers l'API
    location /api/myjourney/health {
        # Logs détaillés
        access_log /var/log/nginx/myjourney-health.log;
        
        proxy_pass http://10.100.9.40:3000/api/myjourney/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Headers de debug
        add_header X-Debug-Backend "10.100.9.40:3000" always;
        add_header X-Debug-Path "$request_uri" always;
        
        # Timeouts courts pour debug
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Toutes les autres routes /api/myjourney
    location /api/myjourney/ {
        access_log /var/log/nginx/myjourney-api.log;
        
        proxy_pass http://10.100.9.40:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header X-Debug-Backend "10.100.9.40:3000" always;
        add_header X-Debug-Path "$request_uri" always;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Page de test pour vérifier que Nginx fonctionne
    location /test {
        return 200 "Nginx fonctionne correctement\n";
        add_header Content-Type text/plain;
    }
}